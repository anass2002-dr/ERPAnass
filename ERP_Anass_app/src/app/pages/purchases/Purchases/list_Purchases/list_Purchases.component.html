<main class="main" id="main">
  <div class="pagetitle">
    <h1>Purchases</h1>
    <nav>
      <ol class="breadcrumb" id="list_nav">
        <li *ngFor="let breadcrumb of breadcrumbs" class="breadcrumb-item">
          <a [routerLink]="'/'+formatBreadcrumbLink(breadcrumb,breadcrumbs)">{{ formatBreadcrumb(breadcrumb) }}</a>
        </li>
      </ol>
    </nav>
  </div>
  
  <div *ngIf="loading" class="spinner-overlay">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <section class="section">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Purchase List</h5>

        <div class="d-flex justify-content-between align-items-center mb-3">
           <div class="search-bar">
              <div class="input-group">
                 <span class="input-group-text"><i class="bi bi-search"></i></span>
                 <input type="text" class="form-control" placeholder="Search Purchases..." (keyup)="applyFilter($event)">
              </div>
           </div>
           <div>
              <a routerLink="../add_Purchases" class="btn btn-primary me-2">
                 <i class="bi bi-plus-lg"></i> New Purchase
              </a>
              <button class="btn btn-outline-secondary me-1"><i class="bi bi-file-earmark-arrow-down"></i> Export</button>
           </div>
        </div>

        <div class="table-responsive">
          <table mat-table [dataSource]="dataSource" matSort (matSortChange)="announceSortChange($event)" class="table table-hover align-middle">

            <ng-container matColumnDef="purchaseRef">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Ref </th>
              <td mat-cell *matCellDef="let element"> 
                  <span class="fw-bold text-primary">{{element.purchaseRef}}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="purchaseDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Date </th>
              <td mat-cell *matCellDef="let element"> {{element.purchaseDate | date:'mediumDate'}} </td>
            </ng-container>

            <ng-container matColumnDef="totalAmount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Total </th>
              <td mat-cell *matCellDef="let element" class="fw-bold"> {{element.totalAmount | currency: element.currencyName}} </td>
            </ng-container>

            <ng-container matColumnDef="currencyName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Currency </th>
                <td mat-cell *matCellDef="let element"> {{element.currencyName}} </td>
            </ng-container>

            <ng-container matColumnDef="supplierName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Supplier </th>
              <td mat-cell *matCellDef="let element"> {{element.supplierName}} </td>
            </ng-container>

            <ng-container matColumnDef="paymentStatus">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Payment </th>
              <td mat-cell *matCellDef="let element">
                 <span class="badge" 
                    [ngClass]="{
                        'bg-success': element.paymentStatus === 'Completed' || element.paymentStatus === 'Paid',
                        'bg-warning': element.paymentStatus === 'Pending' || element.paymentStatus === 'In Progress' || element.paymentStatus === 'Partial',
                        'bg-danger': element.paymentStatus === 'No payment' || element.paymentStatus === 'Unpaid'
                    }">
                    {{element.paymentStatus}}
                 </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="paymentDate">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Payment Date </th>
                <td mat-cell *matCellDef="let element"> {{element.paymentDate | date:'shortDate'}} </td>
            </ng-container>

            <ng-container matColumnDef="createdAt">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Created </th>
                <td mat-cell *matCellDef="let element"> {{element.createdAt | date:'shortDate'}} </td>
            </ng-container>

            <ng-container matColumnDef="updatedAt">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Updated </th>
                <td mat-cell *matCellDef="let element"> {{element.updatedAt | date:'shortDate'}} </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef> Actions </th>
              <td mat-cell *matCellDef="let element">
                <button mat-icon-button [matMenuTriggerFor]="menu" class="btn btn-sm btn-light">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="edit(element.idPurchase)">
                        <mat-icon class="text-primary">edit</mat-icon> <span>Edit</span>
                    </button>
                    <button mat-menu-item (click)="Delete(element.idPurchase)">
                        <mat-icon class="text-danger">delete</mat-icon> <span>Delete</span>
                    </button>
                    <mat-divider></mat-divider>
                    <button mat-menu-item>
                        <mat-icon>visibility</mat-icon> <span>View Details</span>
                    </button>
                    <mat-divider></mat-divider>
                    <button mat-menu-item (click)="exportInvoice(element.idPurchase)">
                        <mat-icon class="text-success">picture_as_pdf</mat-icon> <span>Export Invoice</span>
                    </button>
                </mat-menu>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
          <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
        </div>

      </div>
    </div>
    
    <!-- Delete Modal -->
    <div class="model_erp d-none" id="model_erp">
        <div class="d-flex justify-content-end p-2">
            <i class="bi bi-x-square-fill fs-3 cursor-pointer" style="cursor:pointer" (click)="closeModelErp()"></i>
        </div>
        <div class="model_header text-center text-danger">
            <h2>Delete Confirmation</h2>
        </div>
        <div class="model_body text-center p-4">
            <p class="fs-5">Are you sure you want to delete this Purchase?</p>
            <p class="text-muted small">This action cannot be undone.</p>
        </div>
        <div class="model_footer text-center pb-4">
            <button class="btn btn-danger me-2" (click)="DeletePurchase()">Delete</button>
            <button class="btn btn-secondary" (click)="closeModelErp()">Cancel</button>
        </div>
    </div>

  </section>
</main>
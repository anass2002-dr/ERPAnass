<main id="main" class="main">
  <div class="pagetitle">
    <nav>
      <ol class="breadcrumb">
        <li *ngFor="let breadcrumb of breadcrumbs" class="breadcrumb-item">
          <a [routerLink]="'/' + formatBreadcrumbLink(breadcrumb, breadcrumbs)">{{ formatBreadcrumb(breadcrumb) }}</a>
        </li>
      </ol>
    </nav>
  </div>

  <div *ngIf="loading" class="spinner-container">
    <mat-spinner></mat-spinner>
  </div>

  <div class="row">
    <section class="section col-12">
      <div class="card p-3">
        <div class="card-body">
          <h5 class="card-title">Purchase Management</h5>

          <form [formGroup]="FormInputs" (ngSubmit)="onSubmit()" class="row g-3">
            <!-- HEADER SECTION -->
            <div class="col-md-3">
              <label class="form-label">Purchase Ref</label>
              <input type="text" class="form-control" formControlName="purchaseRef" readonly>
            </div>
            <div class="col-md-3">
               <label class="form-label">Purchase Date</label>
               <input type="date" class="form-control" formControlName="purchaseDate">
            </div>
            <div class="col-md-6 text-end align-self-end">
               <button type="submit" class="btn btn-primary" [disabled]="FormInputs.invalid">
                 <i class="bi bi-save"></i> {{ isUpdateMode ? 'Update Header' : 'Create Header' }}
               </button>
            </div>

            <mat-tab-group class="mt-4">
              <!-- GENERAL INFO TAB -->
              <mat-tab label="General Info">
                <div class="row pt-3 g-3">
                   <div class="col-md-4">
                     <label class="form-label">Supplier <span class="text-danger">*</span></label>
                     <ng-select [items]="listSupplier" bindLabel="supplierName" bindValue="idSupplier" formControlName="idSupplier" placeholder="Select Supplier"></ng-select>
                   </div>
                   <div class="col-md-4">
                     <label class="form-label">Warehouse <span class="text-danger">*</span></label>
                     <ng-select [items]="listWarehouses" bindLabel="name" bindValue="idWarehouse" formControlName="idWarehouse" placeholder="Select Warehouse"></ng-select>
                   </div>
                   <div class="col-md-4">
                     <label class="form-label">Expense Account <span class="text-danger">*</span></label>
                     <ng-select [items]="listAccounts" bindLabel="accountName" bindValue="idAccount" formControlName="idAccount" placeholder="Select Expense Account"></ng-select>
                   </div>
                   
                   <div class="col-md-4">
                     <label class="form-label">Purchaser (Employee)</label>
                     <ng-select [items]="listEmployees" bindLabel="firstName" bindValue="employeeID" formControlName="idEmployee" placeholder="Select Employee"></ng-select>
                   </div>
                   <div class="col-md-4">
                      <label class="form-label">Currency</label>
                      <ng-select [items]="Currencies" bindLabel="currencyName" bindValue="idCurrency" formControlName="idCurrency"></ng-select>
                   </div>
                   <div class="col-md-4">
                      <label class="form-label">Status</label>
                      <select class="form-select" formControlName="purchaseStatus">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Received">Received</option>
                        <option value="Cancelled">Cancelled</option>
                      </select>
                   </div>
                </div>
              </mat-tab>

              <!-- LOGISTICS TAB -->
              <mat-tab label="Logistics & Details">
                 <div class="row pt-3 g-3">
                    <div class="col-md-4">
                      <label class="form-label">Expected Delivery</label>
                      <input type="date" class="form-control" formControlName="expectedDeliveryDate">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Purchase Type</label>
                      <select class="form-select" formControlName="purchaseType">
                         <option value="Raw Material">Raw Material</option>
                         <option value="Services">Services</option>
                         <option value="Equipment">Equipment</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                       <label class="form-label">Shipping Address</label>
                       <textarea class="form-control" formControlName="shippingAddress" rows="1"></textarea>
                    </div>
                    <div class="col-md-12">
                       <label class="form-label">Remarks</label>
                       <textarea class="form-control" formControlName="remarks" rows="2"></textarea>
                    </div>
                 </div>
              </mat-tab>

              <!-- ITEMS TAB -->
              <mat-tab label="Line Items" [disabled]="!isUpdateMode">
                <div class="row pt-3">
                   <!-- ITEM LIST -->
                   <div class="col-md-12 mb-3">
                      <div class="card border-primary mb-3">
                        <div class="card-header bg-primary text-white py-2">
                           <h6 class="card-title mb-0 text-white"><i class="bi bi-cart-plus me-2"></i>Add New Item</h6>
                        </div>
                        <div class="card-body p-3">
                           <form [formGroup]="FormInputsDetails" (ngSubmit)="onSubmitDetails()">
                              <div class="row g-3">
                                 <!-- Product Selection Row -->
                                 <div class="col-md-4">
                                    <label class="form-label small fw-bold">Product</label>
                                    <ng-select [items]="list" bindLabel="articleName" bindValue="idArticle" formControlName="idArticle" (change)="AddArticle($event?.idArticle)" placeholder="Search Product" class="form-control-sm-custom"></ng-select>
                                 </div>
                                 <div class="col-md-2">
                                   <label class="form-label small fw-bold">Quality</label>
                                   <select class="form-select form-select-sm" formControlName="quality">
                                       <option value="New">New</option>
                                       <option value="Used">Used</option>
                                       <option value="Defective">Defective</option>
                                   </select>
                                 </div>
                                 <div class="col-md-2">
                                   <label class="form-label small fw-bold">UoM</label>
                                   <ng-select [items]="listUoms" bindValue="idUom" formControlName="idUom" placeholder="Unit" class="form-control-sm-custom">
                                      <ng-template ng-label-tmp let-item="item">
                                          {{item.uomName}} ({{item.multiplier}})
                                      </ng-template>
                                      <ng-template ng-option-tmp let-item="item">
                                          {{item.uomName}} <small class="text-muted">({{item.multiplier}})</small>
                                      </ng-template>
                                   </ng-select>
                                 </div>
                                 <div class="col-md-2">
                                   <label class="form-label small fw-bold">Batch No.</label>
                                   <input type="text" class="form-control form-control-sm" formControlName="batchNumber" placeholder="Batch">
                                 </div>
                                 <div class="col-md-2">
                                   <label class="form-label small fw-bold">Expiry Date</label>
                                   <input type="date" class="form-control form-control-sm" formControlName="expiryDate">
                                 </div>

                                 <!-- Pricing & Quantity Row -->
                                 <div class="col-md-2">
                                   <label class="form-label small fw-bold">Serial No.</label>
                                   <input type="text" class="form-control form-control-sm" formControlName="serialNumber" placeholder="Serial">
                                 </div>
                                 <div class="col-md-2">
                                    <label class="form-label small fw-bold">Qty (Pack)</label>
                                    <input type="number" class="form-control form-control-sm" formControlName="inputQuantity" placeholder="0">
                                 </div>
                                 <div class="col-md-2">
                                    <label class="form-label small fw-bold">Price/Pack</label>
                                    <input type="number" class="form-control form-control-sm" formControlName="inputUnitPrice" placeholder="0.00">
                                 </div>
                                 <div class="col-md-2">
                                    <label class="form-label small fw-bold">Tax Config</label>
                                    <ng-select [items]="listTaxes" bindLabel="taxName" bindValue="idTaxConfig" formControlName="idTaxConfig" placeholder="Tax" class="form-control-sm-custom"></ng-select>
                                 </div>
                                 <div class="col-md-2">
                                    <label class="form-label small fw-bold">Extra Tax</label>
                                    <input type="number" class="form-control form-control-sm" formControlName="extraTax" placeholder="0.00">
                                 </div>
                                 <div class="col-md-2">
                                    <label class="form-label small fw-bold">Total</label>
                                    <input type="text" class="form-control form-control-sm bg-light fw-bold text-end" formControlName="totalPrice" readonly>
                                 </div>
                              </div>
                              
                              <div class="row mt-3">
                                 <div class="col-md-12 text-end">
                                    <button type="button" class="btn btn-secondary btn-sm me-2" *ngIf="isUpdateModeDetails" (click)="resetDetails()">Cancel</button>
                                    <button type="submit" class="btn btn-success btn-sm px-4" [disabled]="FormInputsDetails.invalid">
                                       <i class="bi bi-plus-lg me-1"></i> {{ isUpdateModeDetails ? 'Update Item' : 'Add Item' }}
                                    </button>
                                 </div>
                              </div>
                           </form>
                        </div>
                      </div>
                   </div>

                   <!-- TABLE -->
                   <div class="col-md-12">
                      <table mat-table [dataSource]="dataSourcePurchase" class="w-100 mat-elevation-z2">
                         <ng-container matColumnDef="articleName">
                            <th mat-header-cell *matHeaderCellDef> Product </th>
                            <td mat-cell *matCellDef="let element"> {{element.article?.articleName}} </td>
                         </ng-container>
                         <ng-container matColumnDef="quality">
                            <th mat-header-cell *matHeaderCellDef> Quality </th>
                            <td mat-cell *matCellDef="let element"> {{element.quality}} </td>
                         </ng-container>
                         <ng-container matColumnDef="unitOfMeasure">
                            <th mat-header-cell *matHeaderCellDef> UoM </th>
                            <td mat-cell *matCellDef="let element"> {{element.unitOfMeasure}} </td>
                         </ng-container>
                         <ng-container matColumnDef="batchNumber">
                            <th mat-header-cell *matHeaderCellDef> Batch </th>
                            <td mat-cell *matCellDef="let element"> {{element.batchNumber}} </td>
                         </ng-container>
                         <ng-container matColumnDef="expiryDate">
                             <th mat-header-cell *matHeaderCellDef> Expiry </th>
                             <td mat-cell *matCellDef="let element"> {{element.expiryDate | date:'shortDate'}} </td>
                         </ng-container>
                         <ng-container matColumnDef="serialNumber">
                             <th mat-header-cell *matHeaderCellDef> Serial </th>
                             <td mat-cell *matCellDef="let element"> {{element.serialNumber}} </td>
                         </ng-container>

                         <ng-container matColumnDef="quantity">
                            <th mat-header-cell *matHeaderCellDef> Qty </th>
                            <td mat-cell *matCellDef="let element"> {{element.quantity}} </td>
                         </ng-container>
                         <ng-container matColumnDef="unitPrice">
                            <th mat-header-cell *matHeaderCellDef> Price </th>
                            <td mat-cell *matCellDef="let element"> {{element.unitPrice | currency}} </td>
                         </ng-container>
                         <ng-container matColumnDef="tax">
                            <th mat-header-cell *matHeaderCellDef> Tax </th>
                            <td mat-cell *matCellDef="let element"> {{element.taxAmount | currency}} </td>
                         </ng-container>
                         <ng-container matColumnDef="extraTax">
                             <th mat-header-cell *matHeaderCellDef> Extra Tax </th>
                             <td mat-cell *matCellDef="let element"> {{element.extraTax | currency}} </td>
                         </ng-container>
                         <ng-container matColumnDef="totalPrice">
                            <th mat-header-cell *matHeaderCellDef> Total </th>
                            <td mat-cell *matCellDef="let element"> {{element.totalPrice | currency}} </td>
                         </ng-container>
                         <ng-container matColumnDef="update">
                            <th mat-header-cell *matHeaderCellDef> Edit </th>
                            <td mat-cell *matCellDef="let element">
                               <button mat-icon-button color="primary" (click)="updatePurchaseDetails(element.idPurchaseDetails)">
                                  <mat-icon>edit</mat-icon>
                               </button>
                            </td>
                         </ng-container>
                         <ng-container matColumnDef="delete">
                            <th mat-header-cell *matHeaderCellDef> Delete </th>
                            <td mat-cell *matCellDef="let element">
                               <button mat-icon-button color="warn" (click)="deletePurchaseDetails(element.idPurchaseDetails)">
                                  <mat-icon>delete</mat-icon>
                               </button>
                            </td>
                         </ng-container>

                         <tr mat-header-row *matHeaderRowDef="ColumnsPurchaseDetails"></tr>
                         <tr mat-row *matRowDef="let row; columns: ColumnsPurchaseDetails;"></tr>
                      </table>
                   </div>
                </div>
              </mat-tab>
              
              <!-- PAYMENT TAB -->
              <mat-tab label="Payment Info">
                  <div class="row pt-3 g-3">
                     <div class="col-md-4">
                        <label class="form-label">Payment Status</label>
                        <select class="form-select" formControlName="paymentStatus">
                           <option value="No payment">No payment</option>
                           <option value="In Progress">In Progress</option>
                           <option value="Paid">Paid</option>
                        </select>
                     </div>
                     <div class="col-md-4">
                        <label class="form-label">Payment Date</label>
                        <input type="date" class="form-control" formControlName="paymentDate">
                     </div>
                     <div class="col-md-4">
                        <label class="form-label">Total Amount</label>
                        <input type="number" class="form-control" formControlName="totalAmount" readonly>
                     </div>
                     <div class="col-md-2">
                        <label class="form-label">Discount Amount</label>
                        <input type="number" class="form-control" formControlName="discountAmount" readonly>
                     </div>
                     <div class="col-md-2">
                        <label class="form-label">Extra Tax</label>
                        <input type="number" class="form-control" formControlName="extraTax" placeholder="0.00">
                     </div>
                     <div class="col-md-4">
                        <label class="form-label">Tax Total</label>
                        <input type="number" class="form-control" formControlName="totalTaxAmount" readonly>
                     </div>
                  </div>
              </mat-tab>

            </mat-tab-group>

            <!-- Buttons -->
            <div class="text-start">
              <button type="submit" class="btn btn-primary m-2" *ngIf="!isUpdateMode"> Create </button>
              <button type="submit" class="btn btn-primary m-2" *ngIf="isUpdateMode"> Update </button>
              <button type="button" class="btn btn-info m-2" *ngIf="isUpdateMode" (click)="previewInvoice()">
                 <i class="bi bi-file-earmark-pdf"></i> Preview Invoice
              </button>
              <a routerLink="/purchases" class="btn btn-secondary m-2">Cancel</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Alerts -->
      <div *ngIf="showAlert" class="alert alert-danger alert-dismissible fade show" role="alert">
        All fields are required.
        <button type="button" class="btn-close" (click)="showAlert=false"></button>
      </div>
    </section>
  </div>
</main>

<div *ngIf="showAlertSuccess" class="alert alert-success alert-dismissible fade show fixed-bottom m-3" style="width: auto; right: 20px; bottom: 20px;">
  Operation Successful!
  <button type="button" class="btn-close" (click)="showAlertSuccess=false"></button>
</div>

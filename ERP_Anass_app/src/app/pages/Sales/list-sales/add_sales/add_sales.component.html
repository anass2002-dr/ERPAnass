<main id="main" class="main">
  <div class="pagetitle">
    <nav>
      <ol class="breadcrumb" id="list_nav">
        <li *ngFor="let breadcrumb of breadcrumbs" class="breadcrumb-item">
          <a [routerLink]="'/' + formatBreadcrumbLink(breadcrumb, breadcrumbs)">{{ formatBreadcrumb(breadcrumb) }}</a>
        </li>
      </ol>
    </nav>
  </div>

  <div *ngIf="loading" class="spinner-container">
    <mat-spinner></mat-spinner>
  </div>

  <div class="row">
    <section class="section col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">New sale</h5>

          <form [formGroup]="FormInputs" (ngSubmit)="onSubmit()" class="row g-4">
            <!-- sale Ref -->
            <div class="col-6">
              <div class="card m-2 h-100">
                <div class="card-header">
                  sale
                </div>
                <div class="card-body row mt-2">
                  <div class="col-12">
                    <label for="saleRef" class="form-label">sale Ref</label>
                    <input type="text" id="saleRef" formControlName="saleRef" class="form-control" [value]="ref"
                      readonly>
                    <button type="button" *ngIf="!isUpdateMode" class="btn btn-primary mt-2" (click)="generateRef()">
                      <i class="ri-history-line"></i> Generate Ref
                    </button>
                    <div
                      *ngIf="FormInputs.get('saleRef')?.invalid && (FormInputs.get('saleRef')?.touched || showAlert)">
                      <small class="text-danger" *ngIf="FormInputs.get('saleRef')?.errors?.['required']">sale
                        Ref
                        is
                        required.</small>
                    </div>
                  </div>


                  <div class="12">
                    <label for="saleChannel" class="form-label">sale Channel</label>
                    <select id="saleChannel" formControlName="saleChannel" class="form-select">
                      <option value="Offline">Offline</option>
                      <option value="Online">Online</option>
                    </select>
                  </div>

                  <!-- sale Date -->
                  <div class="col-12">
                    <label for="saleDate" class="form-label">sale Date</label>
                    <input type="datetime-local" id="saleDate" formControlName="saleDate" class="form-control">
                    <div
                      *ngIf="FormInputs.get('saleDate')?.invalid && (FormInputs.get('saleDate')?.touched || showAlert)">
                      <small class="text-danger" *ngIf="FormInputs.get('saleDate')?.errors?.['required']">sale
                        Date is
                        required.</small>
                    </div>
                  </div>
                  <!-- Customer -->
                  <div class="col-12">
                    <ng-select [items]="listCustomer" bindLabel="CustomerName" bindValue="idCustomer"
                      formControlName="idCustomer" [searchable]="true" placeholder="Select Customer"
                      class="mt-2 custom">
                    </ng-select>
                    <div
                      *ngIf="FormInputs.get('idCustomer')?.invalid && (FormInputs.get('idCustomer')?.touched || showAlert)">
                      <small class="text-danger" *ngIf="FormInputs.get('idCustomer')?.errors?.['required']">Customer is
                        required.</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-6">
              <div class="card m-2 h-100">
                <div class="card-header">
                  sale Details
                </div>
                <div class="card-body mt-2">

                  <!-- Additional Fields -->
                  <div class="col-12">
                    <label for="saleStatus" class="form-label">sale Status</label>
                    <select id="saleStatus" formControlName="saleStatus" class="form-select">
                      <option value="Completed">Completed</option>
                      <option value="Pending">Pending</option>
                      <option value="Rejected">Rejected</option>
                    </select>
                  </div>

                  <div class="col-12">
                    <label for="expectedDeliveryDate" class="form-label">Expected Delivery Date</label>
                    <input type="datetime-local" id="expectedDeliveryDate" formControlName="expectedDeliveryDate"
                      class="form-control">
                  </div>


                  <div class="col-12">
                    <label for="saleType" class="form-label">sale Type</label>
                    <select id="saleType" formControlName="saleType" class="form-select">
                      <option value="Raw Material">Raw Material</option>
                      <option value="Services">Services</option>
                      <option value="Equipment">Equipment</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label for="shippingAddress" class="form-label">Shipping Address</label>
                    <textarea id="shippingAddress" formControlName="shippingAddress" class="form-control"></textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="card m-2 h-100">
                <div class="card-header">
                  Payment
                </div>
                <div class="card-body  mt-2 row">

                  <!-- Payment Date -->
                  <div class="col-4">
                    <label for="paymentDate" class="form-label">Payment Date</label>
                    <input type="datetime-local" id="paymentDate" formControlName="paymentDate" class="form-control">
                    <div
                      *ngIf="FormInputs.get('paymentDate')?.invalid && (FormInputs.get('paymentDate')?.touched || showAlert)">
                      <small class="text-danger" *ngIf="FormInputs.get('paymentDate')?.errors?.['required']">Payment
                        Date
                        is
                        required.</small>
                    </div>
                  </div>

                  <!-- Currency -->
                  <div class="col-4">
                    <label for="idCurrency" class="form-label">Currency</label>
                    <select id="idCurrency" formControlName="idCurrency" class="form-select">
                      <option *ngFor="let currency of Currencies" [value]="currency.idCurrency">{{ currency.currencyName
                        }}
                      </option>
                    </select>
                    <div
                      *ngIf="FormInputs.get('idCurrency')?.invalid && (FormInputs.get('idCurrency')?.touched || showAlert)">
                      <small class="text-danger" *ngIf="FormInputs.get('idCurrency')?.errors?.['required']">Currency is
                        required.</small>
                    </div>
                  </div>

                  <div class="col-4">
                    <label for="exchangeRate" class="form-label">Exchange Rate</label>
                    <input type="text" id="exchangeRate" formControlName="exchangeRate" class="form-control">
                    <div
                      *ngIf="FormInputs.get('exchangeRate')?.invalid && (FormInputs.get('exchangeRate')?.touched || showAlert)">
                      <small class="text-danger" *ngIf="FormInputs.get('exchangeRate')?.errors?.['pattern']">Invalid
                        format.</small>
                    </div>
                  </div>
                  <!-- Total Amount -->
                  <div class="col-4">
                    <label for="totalAmount" class="form-label">Total Amount</label>
                    <input type="number" id="totalAmount" formControlName="totalAmount" class="form-control">
                  </div>

                  <div class="col-4">
                    <label for="discountAmount" class="form-label">Discount Amount</label>
                    <input type="number" id="discountAmount" formControlName="discountAmount" class="form-control">
                  </div>

                  <div class="col-4">
                    <label for="discountPercentage" class="form-label">Discount Percentage (e.g., 10%)</label>
                    <input type="number" id="discountPercentage" formControlName="discountPercentage"
                      class="form-control">
                  </div>

                  <div class="col-4">
                    <label for="taxRate" class="form-label">Tax Rate</label>
                    <input type="number" id="taxRate" formControlName="taxRate" class="form-control">
                  </div>

                  <div class="col-4">
                    <label for="totalTaxAmount" class="form-label">Total Tax Amount</label>
                    <input type="text" id="totalTaxAmount" formControlName="totalTaxAmount" class="form-control"
                      readonly>
                  </div>

                  <div class="col-4">
                    <label for="shippingAmount" class="form-label">shippingAmount</label>
                    <input type="text" id="shippingAmount" formControlName="shippingAmount" class="form-control">
                  </div>

                  <div class="col-4">
                    <label for="TotalPayment" class="form-label">Total Payment</label>
                    <input type="text" id="TotalPayment" formControlName="TotalPayment" class="form-control" readonly>
                  </div>

                  <!-- Payment Status -->
                  <div class="col-4">
                    <label for="paymentStatus" class="form-label">Payment Status</label>
                    <select id="paymentStatus" formControlName="paymentStatus" class="form-select">
                      <option value="In progress">In progress</option>
                      <option value="Completed">Completed</option>
                      <option value="No payment">No payment</option>
                    </select>
                    <div
                      *ngIf="FormInputs.get('paymentStatus')?.invalid && (FormInputs.get('paymentStatus')?.touched || showAlert)">
                      <small class="text-danger" *ngIf="FormInputs.get('paymentStatus')?.errors?.['required']">Payment
                        Status
                        is required.</small>
                    </div>
                  </div>
                  <div class="col-4">
                    <label for="paymentTerms" class="form-label">Payment Terms</label>
                    <input type="text" id="paymentTerms" formControlName="paymentTerms" class="form-control">
                  </div>
                  <!-- Remarks -->
                  <div class="col-4">
                    <label for="remarks" class="form-label">Remarks</label>
                    <textarea id="remarks" formControlName="remarks" class="form-control"></textarea>
                  </div>
                </div>
              </div>
            </div>



            <!-- Buttons -->
            <div class="text-start">
              <button type="submit" class="btn btn-primary m-2" *ngIf="!isUpdateMode">Create</button>
              <button type="submit" class="btn btn-primary m-2" *ngIf="isUpdateMode">Update</button>
              <a routerLink="/sales" class="btn btn-secondary m-2">Cancel</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Alerts -->
      <div *ngIf="showAlert" class="alert alert-danger alert-dismissible fade show" role="alert">
        All fields are required.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"
          (click)="showAlert = false"></button>
      </div>
      <div *ngIf="showAlertSuccess" class="alert alert-success alert-dismissible fade show" role="alert">
        Operation completed with success
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"
          (click)="showAlertSuccess = false"></button>
      </div>
    </section>

    <!-- Available Products Section -->
    <section class="section col-6" [ngClass]="{ 'disabled-section': SetDisable }">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Available Products</h5>
          <div class="mat-elevation-z8">
            <table mat-table [dataSource]="dataSource" matSort (matSortChange)="announceSortChange($event)"
              class="mat-elevation-z8 w-100">
              <!-- Article Ref Column -->
              <ng-container matColumnDef="articleRef">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Ref.</th>
                <td mat-cell *matCellDef="let element">{{ element.articleRef }}</td>
              </ng-container>

              <!-- Article Name Column -->
              <ng-container matColumnDef="articleName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Article Name</th>
                <td mat-cell *matCellDef="let element">{{ element.articleName }}</td>
              </ng-container>

              <!-- Family Name Column -->
              <ng-container matColumnDef="familyName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Family Name</th>
                <td mat-cell *matCellDef="let element">{{ element.familly?.familyName || 'N/A' }}</td>
              </ng-container>

              <!-- Stock Quantity Column -->
              <ng-container matColumnDef="stockQuantity">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Stock Quantity</th>
                <td mat-cell *matCellDef="let element">{{ element.stockQuantity }}</td>
              </ng-container>

              <!-- Add Button Column -->
              <ng-container matColumnDef="ADD">
                <th mat-header-cell *matHeaderCellDef>ADD</th>
                <td mat-cell *matCellDef="let element">
                  <button class="btn btn-success" (click)="AddArticle(element.idArticle)">
                    <i class="bi bi-arrow-right"></i>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
            <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
          </div>
        </div>
      </div>
    </section>

    <section class="section col-6" [ngClass]="{ 'disabled-section': SetDisable }">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">sale Details</h5>
          <form [formGroup]="FormInputsDetails" (ngSubmit)="onSubmitDetails()" class="row g-3">
            <!-- Article Ref -->
            <div class="col-4">
              <label for="articleRef" class="form-label">Article Ref</label>
              <input type="text" id="articleRef" formControlName="articleRef" class="form-control" readonly>
            </div>

            <!-- Article Name -->
            <div class="col-4">
              <label for="articleName" class="form-label">Article Name</label>
              <input type="text" id="articleName" formControlName="articleName" class="form-control" readonly>
            </div>

            <!-- Quantity -->
            <div class="col-4">
              <label for="quantity" class="form-label">Quantity</label>
              <input type="text" id="quantity" formControlName="quantity" class="form-control">

              <div *ngIf="FormInputs.get('quantity')?.invalid && (FormInputs.get('quantity')?.touched || showAlert)">
                <small class="text-danger" *ngIf="FormInputs.get('quantity')?.errors?.['required']">this field is
                  required.</small>
                <small class="text-danger" *ngIf="FormInputs.get('quantity')?.errors?.['pattern']">Invalid
                  format.</small>
              </div>
            </div>
            <div class="col-4">
              <label for="unitPrice" class="form-label">Unit Price</label>
              <input type="text" id="unitPrice" formControlName="unitPrice" class="form-control">
              <div *ngIf="FormInputs.get('unitPrice')?.invalid && (FormInputs.get('unitPrice')?.touched || showAlert)">
                <small class="text-danger" *ngIf="FormInputs.get('unitPrice')?.errors?.['required']">this field is
                  required.</small>
                <small class="text-danger" *ngIf="FormInputs.get('unitPrice')?.errors?.['pattern']">Invalid
                  format.</small>
              </div>
            </div>
            <div class="col-4">
              <label for="lineDiscountAmount" class="form-label">Discount Amount</label>
              <input type="text" id="lineDiscountAmount" formControlName="lineDiscountAmount" class="form-control">

            </div>

            <div class="col-4">
              <label for="lineDiscountPercentage" class="form-label">Discount Percentage</label>
              <input type="text" id="lineDiscountPercentage" formControlName="lineDiscountPercentage"
                class="form-control">

            </div>
            <!-- Tax Amount -->
            <div class="col-4">
              <label for="lineTaxRate" class="form-label">Tax Rate</label>
              <input type="text" id="lineTaxRate" formControlName="lineTaxRate" class="form-control">
              <div
                *ngIf="FormInputs.get('lineTaxRate')?.invalid && (FormInputs.get('lineTaxRate')?.touched || showAlert)">
                <small class="text-danger" *ngIf="FormInputs.get('lineTaxRate')?.errors?.['pattern']">Invalid
                  format.</small>
              </div>
            </div>
            <!-- Tax Amount -->
            <div class="col-4">
              <label for="taxAmount" class="form-label">Tax Amount</label>
              <input type="text" id="taxAmount" formControlName="taxAmount" class="form-control">
              <div *ngIf="FormInputs.get('taxAmount')?.invalid && (FormInputs.get('taxAmount')?.touched || showAlert)">
                <small class="text-danger" *ngIf="FormInputs.get('taxAmount')?.errors?.['pattern']">Invalid
                  format.</small>
              </div>
            </div>

            <!-- Total Price -->
            <div class="col-4">
              <label for="totalPrice" class="form-label">Total Price</label>
              <input type="text" id="totalPrice" formControlName="totalPrice" class="form-control">
              <div
                *ngIf="FormInputs.get('totalPrice')?.invalid && (FormInputs.get('totalPrice')?.touched || showAlert)">
                <small class="text-danger" *ngIf="FormInputs.get('totalPrice')?.errors?.['required']">this field is
                  required.</small>
                <small class="text-danger" *ngIf="FormInputs.get('totalPrice')?.errors?.['pattern']">Invalid
                  format.</small>
              </div>
            </div>


            <!-- Quality -->
            <div class="col-12">
              <label for="quality" class="form-label">Quality</label>
              <div class="d-flex">
                <div class="form-check m-2">
                  <input class="form-check-input" type="radio" name="quality" formControlName="quality" id="New"
                    value="New">
                  <label class="form-check-label" for="New">New</label>
                </div>
                <div class="form-check m-2">
                  <input class="form-check-input" type="radio" name="quality" formControlName="quality" id="Good"
                    value="Good">
                  <label class="form-check-label" for="Good">Good</label>
                </div>
                <div class="form-check m-2">
                  <input class="form-check-input" type="radio" name="quality" formControlName="quality" id="Normale"
                    value="Normale">
                  <label class="form-check-label" for="Normale">Normale</label>
                </div>
                <div class="form-check m-2">
                  <input class="form-check-input" type="radio" name="quality" formControlName="quality" id="Low"
                    value="Low">
                  <label class="form-check-label" for="Low">Low</label>
                </div>
              </div>
            </div>

            <!-- Additional Fields -->
            <div class="col-4">
              <label for="lineItemStatus" class="form-label">Line Item Status</label>
              <select id="lineItemStatus" formControlName="lineItemStatus" class="form-select">
                <option value="Pending">Pending</option>
                <option value="Received">Received</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>

            <div class="col-4">
              <label for="unitOfMeasure" class="form-label">Unit of Measure</label>
              <select id="unitOfMeasure" formControlName="unitOfMeasure" class="form-select">
                <option value="Pieces">Pieces</option>
                <option value="Kilograms">Kilograms</option>
                <option value="Liters">Liters</option>
              </select>
              <div
                *ngIf="FormInputs.get('unitOfMeasure')?.invalid && (FormInputs.get('unitOfMeasure')?.touched || showAlert)">
                <small class="text-danger" *ngIf="FormInputs.get('unitOfMeasure')?.errors?.['required']">this field is
                  required.</small>

              </div>
            </div>

            <div class="col-4">
              <label for="batchNumber" class="form-label">Batch Number</label>
              <input type="text" id="batchNumber" formControlName="batchNumber" class="form-control">
            </div>

            <div class="col-4">
              <label for="expiryDate" class="form-label">Expiry Date</label>
              <input type="date" id="expiryDate" formControlName="expiryDate" class="form-control">
            </div>

            <div class="col-4">
              <label for="serialNumber" class="form-label">Serial Number</label>
              <input type="text" id="serialNumber" formControlName="serialNumber" class="form-control">
            </div>

            <div class="col-4">
              <label for="warehouseLocation" class="form-label">Warehouse Location</label>
              <input type="text" id="warehouseLocation" formControlName="warehouseLocation" class="form-control">
            </div>

            <div class="col-4">
              <label for="receivedQuantity" class="form-label">Received Quantity</label>
              <input type="text" id="receivedQuantity" formControlName="receivedQuantity" class="form-control">
              <div
                *ngIf="FormInputs.get('receivedQuantity')?.invalid && (FormInputs.get('receivedQuantity')?.touched || showAlert)">
                <small class="text-danger" *ngIf="FormInputs.get('receivedQuantity')?.errors?.['required']">this field
                  is required.</small>
                <small class="text-danger" *ngIf="FormInputs.get('receivedQuantity')?.errors?.['pattern']">Invalid
                  format.</small>
              </div>
            </div>

            <div class="col-4">
              <label for="rejectedQuantity" class="form-label">Rejected Quantity</label>
              <input type="text" id="rejectedQuantity" formControlName="rejectedQuantity" class="form-control">
              <div
                *ngIf="FormInputs.get('rejectedQuantity')?.invalid && (FormInputs.get('rejectedQuantity')?.touched || showAlert)">
                <small class="text-danger" *ngIf="FormInputs.get('rejectedQuantity')?.errors?.['required']">this field
                  is required.</small>
                <small class="text-danger" *ngIf="FormInputs.get('rejectedQuantity')?.errors?.['pattern']">Invalid
                  format.</small>
              </div>
            </div>

            <div class="col-4">
              <label for="lineTaxRate" class="form-label">Line Tax Rate</label>
              <input type="text" id="lineTaxRate" formControlName="lineTaxRate" class="form-control">
              <div
                *ngIf="FormInputs.get('lineTaxRate')?.invalid && (FormInputs.get('lineTaxRate')?.touched || showAlert)">
                <small class="text-danger" *ngIf="FormInputs.get('lineTaxRate')?.errors?.['pattern']">Invalid
                  format.</small>
              </div>
            </div>

            <!-- Buttons -->
            <div class="text-start">
              <button type="submit" class="btn btn-primary m-2" *ngIf="!isUpdateModeDetails">Add</button>
              <button type="submit" class="btn btn-primary m-2" *ngIf="isUpdateModeDetails">Update</button>
              <button type="button" class="btn btn-secondary m-2" (click)="reset()">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- sale Details List -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">sale Details List</h5>
          <div class="mat-elevation-z8">
            <table mat-table [dataSource]="dataSourcesale" matSort (matSortChange)="announceSortChange2($event)"
              class="mat-elevation-z8 w-100">
              <!-- Article Name Column -->
              <ng-container matColumnDef="articleName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Article Name</th>
                <td mat-cell *matCellDef="let element">{{ element.article.articleName }}</td>
              </ng-container>

              <!-- Quality Column -->
              <ng-container matColumnDef="quality">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Quality</th>
                <td mat-cell *matCellDef="let element">{{ element.quality }}</td>
              </ng-container>

              <!-- Quantity Column -->
              <ng-container matColumnDef="quantity">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Quantity</th>
                <td mat-cell *matCellDef="let element">{{ element.quantity }}</td>
              </ng-container>

              <!-- Total Price Column -->
              <ng-container matColumnDef="totalPrice">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Total Price</th>
                <td mat-cell *matCellDef="let element">{{ element.totalPrice }}</td>
              </ng-container>

              <!-- Line Item Status Column -->
              <ng-container matColumnDef="lineItemStatus">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Line Item Status</th>
                <td mat-cell *matCellDef="let element">{{ element.lineItemStatus }}</td>
              </ng-container>

              <!-- Batch Number Column -->
              <ng-container matColumnDef="batchNumber">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Batch Number</th>
                <td mat-cell *matCellDef="let element">{{ element.batchNumber }}</td>
              </ng-container>

              <!-- Expiry Date Column -->
              <ng-container matColumnDef="expiryDate">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Expiry Date</th>
                <td mat-cell *matCellDef="let element">{{ element.expiryDate | date }}</td>
              </ng-container>

              <!-- Update Button Column -->
              <ng-container matColumnDef="update">
                <th mat-header-cell *matHeaderCellDef>Update</th>
                <td mat-cell *matCellDef="let element">
                  <button class="btn btn-success"
                    (click)="updateSaleDetails(element.idsaleDetails)">Update</button>
                </td>
              </ng-container>

              <!-- Delete Button Column -->
              <ng-container matColumnDef="delete">
                <th mat-header-cell *matHeaderCellDef>Delete</th>
                <td mat-cell *matCellDef="let element">
                  <button class="btn btn-danger" (click)="deleteSaleDetails(element.idsaleDetails)">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="ColumnssaleDetails"></tr>
              <tr mat-row *matRowDef="let row; columns: ColumnssaleDetails;"></tr>
            </table>
            <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>